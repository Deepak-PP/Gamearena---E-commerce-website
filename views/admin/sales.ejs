<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Product Page - Admin HTML Template</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700" />
    <!-- https://fonts.google.com/specimen/Roboto -->
    <link rel="stylesheet" href="/fontawesome.min.css" />
    <!-- https://fontawesome.com/ -->
    <link rel="stylesheet" href="/bootstrap.min.css" />
    <!-- https://getbootstrap.com/ -->
    <link rel="stylesheet" href="/templatemo-style.css">
    <link href="/mobiscroll.javascript.min.css" rel="stylesheet" />
    
    <!--
	Product Admin CSS Template
	https://templatemo.com/tm-524-product-admin
	-->
</head>


<body id="reportsPage"
    style="background-image: url(https://images.pexels.com/photos/1069798/pexels-photo-1069798.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1); background-size: cover;">
</body>>
<nav class="navbar navbar-expand-xl pl-1">
    <a href="" class="text-decoration-none">
        <span class="h1 text-uppercase text-danger px-2" style=" background-color: rgba(0, 0, 0, 0.6);">Game</span>
        <span class="h1 text-uppercase text-dark bg-danger px-2 ml-n1">Arena</span>
    </a>
    <div class="container h-100">


        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mx-auto h-100">
                <li class="nav-item">
                    <a class="nav-link" href="/admin/dash">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                        <span class="sr-only">(current)</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/sales">
                        <i class="far fa-file-alt"></i></i> Reports
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/categories">
                        <i class="fa-solid fa-puzzle-piece"></i> Categories
                    </a>
                </li>


                <li class="nav-item">
                    <a class="nav-link" href="/admin/products">
                        <i class="fas fa-shopping-cart"></i> Products
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/orders">
                        <i class="fa-regular fa-rectangle-list"></i> Orders
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link active" href="/admin/customers">
                        <i class="far fa-user"></i> Customers
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/admin/coupon">
                        <i class="fa-solid fa-ticket"></i> Coupons
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/banner">
                        <i class="fa-solid fa-panorama"></i> Banner
                    </a>
                </li>



            </ul>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link d-block" href="/admin/adminLogout">
                        <i class="fa-solid fa-power-off"></i><br>Logout
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>



<!-- customer list -->
<div class="container mt-5">
    <div  class="text-light"><h5>TOTAL COLLECTION:</h5><h5 id="totalamount">
    </h5></div>
    <div class="d-flex justify-content-end">
        <button onclick="exportdoc()" class="bg-dark text-danger mx-3" style="cursor: pointer;">Download PDF</button>
        <button onclick="exportcsv()" class="bg-dark text-danger" style="cursor: pointer;">Download CSV</button>
    </div>
    <div class="row tm-content-row justify-content-start">
        


        <div id="range">
           
        </div>
        <label>
            Start Date 
            <input id="start" mbsc-input placeholder="Please select..." />
        </label>
        <label>
            End Date
            <input id="end" mbsc-input placeholder="Please select..." />
        </label>
    <button onclick="getResults()" style="border-radius: 20%;height: 4rem; width: 5rem; cursor: pointer;" class="mt-3 ">GO</button>

        <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12 tm-block-col">
            <div class="tm-bg-primary-dark tm-block tm-block-products">
                <div class="tm-product-table-container">
                    <table class="table table-hover tm-table-small tm-product-table">
                        <thead>
                            <tr>
                                <th scope="col">SL.No</th>
                                <th scope="col">DATE</th>
                                <th scope="col">TIME</th>
                                <th scope="col">PRODUCTS</th>
                                <th scope="col">CUSTOMER</th>
                                <th class="pl-5" scope="col">TOTAL</th>
                              
                                <th scope="col">&nbsp;</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if(orderData.length>0) {
                                for(let i=0;i <orderData.length; i++){ %>
                                    <tr>
                                        
                                        <td>
                                            <%= [i] %>
                                        </td>
                                        <td class="tm-product-DATE">
                                            <%= orderData[i].createdAt.toString().slice(0,16) %>
                                        </td>
                                        <td id="em1">
                                            <%= orderData[i].createdAt.toString().slice(16,24) %>
                                        </td>
                                        <td>
                                            <% for(products of orderData[i].products){ %>
                                                <% for(let j=0;j<products.item.length;j++){ %>

                                               <%=products.quantity %> x <%= products.item[j].name %><br>

                                                <% } %>

                                          <% } %>
                                           
                                        </td>
                                        <td>
                                            <%= addressData[0].name %>
                                        </td>
                                        <td><%= orderData[i].total %></td>
                                       
                                    </tr>

                                    <% } %>

                                        <%}else { %>
                                            <tr>
                                                <td colspan="5">No orders</td>

                                            </tr>
                                            <% } %>

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="tm-footer row tm-mt-small">
    <div class="col-12 font-weight-light">
        <p class="text-center text-white mb-0 px-4 small">
            Copyright &copy; <b>2018</b> All rights reserved.

            Design: <a rel="nofollow noopener" href="https://templatemo.com" class="tm-footer-link">Template Mo</a>
        </p>
    </div>
</footer>

<script src="/jquery-3.3.1.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- https://jquery.com/download/ -->
<script src="/bootstrap.min.js"></script>

<script src="/mobiscroll.javascript.min.js"></script>

<script src="https://kit.fontawesome.com/d4801b7ff5.js" crossorigin="anonymous"></script>
<!-- https://getbootstrap.com/ -->



<script>
    mobiscroll.datepicker('#range', {
            select: 'range',
            startInput: '#start',
            endInput: '#end'
        });


function getResults(){
     const start_Date = document.getElementById('start')
     const end_Date = document.getElementById('end')
     const startDate = start_Date.value
     const endDate = end_Date.value
    $.ajax({
        url: '/admin/salesReport',
        method: 'post',
        data: { startDate, endDate },
        success: function (response) {
          
            const tableBody = document.querySelector(".tm-product-table tbody");
            let html = "";
            let rowNum = 1;

            if (response && response.salesData && response.salesData.length > 0) {
                document.getElementById('totalamount').textContent = response.totalSales
                let orderData = response.salesData;
                let addressData = response.addressData;
              

                orderData.forEach((order) => {
                    html += `<tr>
                            <td>${rowNum++}</td>
                            <td>${order.createdAt.toString().slice(0, 10)}</td>
                            <td>${order.createdAt.toString().slice(11, 19)}</td>
                            <td>${order.products.map((product) => {
                                
                        return `${product.quantity} x ${product.item.name}<br>`;
                    }).join('')}</td>
                            <td>${addressData && addressData.length > 0 ? addressData[0].name : ''}</td>
                            <td>${order.total}</td>
                            <td></td>
                         </tr>`;
                });
            } else {
                html = `<tr><td colspan="7">No sales data found for selected date range</td></tr>`;
            }

            tableBody.innerHTML = html;
        },
        error: function (xhr, status, error) {
            console.log("An error occurred while fetching sales data: ", error);
        }
    });


}

    function exportdoc() {
        const start_Date = document.getElementById("start");
        const end_Date = document.getElementById("end");
        const startDate = start_Date.value;
        const endDate = end_Date.value;
        $.ajax({
            url: "/admin/exportPDF",
            method: "get",
            data: { startDate, endDate },
            xhrFields: {
                responseType: "blob",
            },
            success: function (response) {
       
                const url = window.URL.createObjectURL(response);
               
                const a = document.createElement("a");
                a.href = url;
                a.download = "salesreport1.pdf";
            
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            },
            error: function (xhr, status, error) {
                console.log(xhr.responseText);
            },
        });
    }

    function exportcsv(){
         const start_Date = document.getElementById("start");
        const end_Date = document.getElementById("end");
        const startDate = start_Date.value;
        const endDate = end_Date.value;
        $.ajax({
            url: "/admin/exportCSV",
            method: "get",
            data: { startDate, endDate },
            xhrFields: {
                responseType: "blob",
            },
            success: function (response) {
                const blob = new Blob([response], { type: "text/csv" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "salesreport1.csv";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            },
            error: function (xhr, status, error) {
                console.log(xhr.responseText);
            },
        });
    }
       


    </script>

</body>

</html>